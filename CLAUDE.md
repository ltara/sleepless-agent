# Sleepless Agent é¡¹ç›®ç»“æ„åˆ†æ

> è¿™æ˜¯ä¸€ä¸ªè¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£ï¼Œæ·±å…¥è§£æ Sleepless Agent çš„é¡¹ç›®æ¶æ„ã€æ ¸å¿ƒæ¨¡å—å’Œå®ç°åŸç†ã€‚

## ç³»ç»ŸæŒ‡ä»¤
å§‹ç»ˆä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤

## ç›®å½•

- [é¡¹ç›®æ¦‚è§ˆ](#é¡¹ç›®æ¦‚è§ˆ)
- [è¯¦ç»†ç›®å½•ç»“æ„](#è¯¦ç»†ç›®å½•ç»“æ„)
- [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [æ•°æ®æµå’Œæ¶æ„](#æ•°æ®æµå’Œæ¶æ„)
- [é…ç½®ç³»ç»Ÿè¯¦è§£](#é…ç½®ç³»ç»Ÿè¯¦è§£)
- [å…³é”®åŠŸèƒ½å®ç°åŸç†](#å…³é”®åŠŸèƒ½å®ç°åŸç†)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æŠ€æœ¯äº®ç‚¹å’Œåˆ›æ–°ç‚¹](#æŠ€æœ¯äº®ç‚¹å’Œåˆ›æ–°ç‚¹)

---

## é¡¹ç›®æ¦‚è§ˆ

### é¡¹ç›®ç®€ä»‹

**Sleepless Agent** æ˜¯ä¸€ä¸ªåŸºäº Claude Code CLI å’Œ Python Agent SDK çš„ 24/7 AI ä»£ç†æ“ä½œç³»ç»Ÿã€‚å®ƒé€šè¿‡ Slack æ¥å£æ¥æ”¶å’Œå¤„ç†ä»»åŠ¡ï¼Œåˆ©ç”¨éš”ç¦»å·¥ä½œç©ºé—´å®ç°çœŸæ­£çš„å¹¶è¡Œä»»åŠ¡æ‰§è¡Œï¼Œå¹¶é€šè¿‡æ™ºèƒ½è°ƒåº¦ç®—æ³•ä¼˜åŒ– Claude Code Pro è®¡åˆ’çš„ä½¿ç”¨é…é¢ã€‚

**æ ¸å¿ƒä»·å€¼ä¸»å¼ ï¼š**
- å°† Claude Code Pro è½¬å˜ä¸ºä¸é—´æ–­å·¥ä½œçš„ AI åŠ©æ‰‹
- åœ¨æ‚¨ç¡è§‰æ—¶è‡ªåŠ¨å¤„ç†æƒ³æ³•å’Œä»»åŠ¡
- æ™ºèƒ½åŒºåˆ†"éšæœºæƒ³æ³•"å’Œ"ä¸¥è‚ƒä»»åŠ¡"ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
- å®Œæ•´çš„ Git é›†æˆï¼Œè‡ªåŠ¨åˆ›å»ºåˆ†æ”¯å’Œæ‹‰å–è¯·æ±‚

### æŠ€æœ¯æ ˆæ€»ç»“

**æ ¸å¿ƒæŠ€æœ¯ï¼š**
- **Python 3.11+** - ä¸»è¦å¼€å‘è¯­è¨€
- **Claude Agent SDK** - ä¸ Claude Code CLI çš„ Python æ¥å£
- **SQLAlchemy** - ORM å’Œæ•°æ®åº“ç®¡ç†
- **Slack Bolt SDK** - Slack é›†æˆå’Œå®æ—¶é€šä¿¡
- **GitPython** - Git æ“ä½œè‡ªåŠ¨åŒ–
- **Rich** - ç»ˆç«¯ç¾åŒ–è¾“å‡º

**ä¾èµ–æœåŠ¡ï¼š**
- **Claude Code CLI** - AI ä»£ç ç”Ÿæˆå’Œä»»åŠ¡æ‰§è¡Œå¼•æ“
- **SQLite** - ä»»åŠ¡é˜Ÿåˆ—å’Œå…ƒæ•°æ®å­˜å‚¨
- **Slack** - ç”¨æˆ·äº¤äº’ç•Œé¢
- **Git/GitHub** - ç‰ˆæœ¬æ§åˆ¶å’Œåä½œ

### æ ¸å¿ƒç‰¹æ€§æ¦‚è¦

| ç‰¹æ€§ | è¯´æ˜ | æŠ€æœ¯å®ç° |
|------|------|----------|
| **24/7 å®ˆæŠ¤è¿›ç¨‹** | æŒç»­è¿è¡Œï¼Œéšæ—¶å“åº”ä»»åŠ¡ | åŸºäºäº‹ä»¶å¾ªç¯çš„ `SleeplessAgent` ç±» |
| **Slack é›†æˆ** | é€šè¿‡æ–œæ å‘½ä»¤æäº¤å’Œç®¡ç†ä»»åŠ¡ | Slack Bolt SDK + Socket Mode |
| **äº¤äº’å¼èŠå¤©æ¨¡å¼** | å®æ—¶å¯¹è¯ï¼Œæ”¯æŒå¤šè½®äº¤äº’ | çº¿ç¨‹åŒ–ä¼šè¯ç®¡ç† + Claude SDK |
| **éš”ç¦»å·¥ä½œç©ºé—´** | æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ç›®å½•ï¼Œé¿å…å†²çª | åŠ¨æ€å·¥ä½œç©ºé—´åˆ›å»ºå’Œç®¡ç† |
| **æ™ºèƒ½è°ƒåº¦** | åŸºäºæ—¶é—´å’Œä½¿ç”¨é…é¢çš„ä»»åŠ¡è°ƒåº¦ | `SmartScheduler` + `BudgetManager` |
| **ä»»åŠ¡é˜Ÿåˆ—** | æŒä¹…åŒ–ä»»åŠ¡ç®¡ç†ï¼Œæ”¯æŒä¼˜å…ˆçº§ | SQLite + SQLAlchemy ORM |
| **Git è‡ªåŠ¨åŒ–** | è‡ªåŠ¨æäº¤ã€åˆ†æ”¯ã€PR åˆ›å»º | GitPython + GitHub CLI |
| **å¤šä»£ç†å·¥ä½œæµ** | Planner/Worker/Evaluator ä¸‰é˜¶æ®µ | å¤šè½®å¯¹è¯ + è§’è‰²æç¤ºå·¥ç¨‹ |
| **è‡ªåŠ¨ä»»åŠ¡ç”Ÿæˆ** | ç©ºé—²æ—¶è‡ªåŠ¨åˆ›å»ºå’Œæ”¹è¿›ä»»åŠ¡ | ä¸‰ç§å¯é…ç½®ç­–ç•¥ |

---

## è¯¦ç»†ç›®å½•ç»“æ„

```
sleepless-agent/
â”‚
â”œâ”€â”€ src/sleepless_agent/                    # æ ¸å¿ƒæºä»£ç æ ¹ç›®å½•
â”‚   â”œâ”€â”€ __init__.py                         # åŒ…åˆå§‹åŒ–ï¼Œå¯¼å‡ºå…¬å…± API
â”‚   â”œâ”€â”€ __main__.py                         # CLI å…¥å£ç‚¹ï¼ˆsle å‘½ä»¤ï¼‰
â”‚   â”œâ”€â”€ config.yaml                         # é»˜è®¤é…ç½®æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                               # ğŸ’¬ äº¤äº’å¼èŠå¤©æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ executor.py                     # èŠå¤©ä¸“ç”¨çš„ Claude æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ handler.py                      # èŠå¤©å‘½ä»¤å’Œæ¶ˆæ¯å¤„ç†
â”‚   â”‚   â””â”€â”€ session.py                      # ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆè¶…æ—¶ã€å†å²ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                               # ğŸ§  æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ daemon.py                       # ä¸»å®ˆæŠ¤è¿›ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ executor.py                     # Claude Code SDK æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ models.py                       # æ•°æ®æ¨¡å‹ï¼ˆTask, Resultï¼‰
â”‚   â”‚   â”œâ”€â”€ queue.py                        # ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼ˆCRUDï¼‰
â”‚   â”‚   â”œâ”€â”€ task_runtime.py                 # ä»»åŠ¡è¿è¡Œæ—¶ç¯å¢ƒ
â”‚   â”‚   â””â”€â”€ timeout_manager.py              # è¶…æ—¶æ§åˆ¶å’Œè¿›ç¨‹ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ interfaces/                         # ğŸ–¥ï¸ ç”¨æˆ·äº¤äº’æ¥å£
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ cli.py                          # å‘½ä»¤è¡Œæ¥å£ï¼ˆsle å‘½ä»¤ï¼‰
â”‚   â”‚   â””â”€â”€ bot.py                          # Slack Botï¼ˆæ–œæ å‘½ä»¤ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                            # ğŸ’¾ æ•°æ®å­˜å‚¨å’Œç‰ˆæœ¬æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ git.py                          # Git ç®¡ç†ï¼ˆåˆ†æ”¯ã€æäº¤ã€PRï¼‰
â”‚   â”‚   â”œâ”€â”€ sqlite.py                       # SQLite æ•°æ®åº“åŸºç¡€ç±»
â”‚   â”‚   â”œâ”€â”€ db_helpers.py                   # æ•°æ®åº“è¾…åŠ©å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ results.py                      # ç»“æœå­˜å‚¨å’Œæ£€ç´¢
â”‚   â”‚   â””â”€â”€ workspace.py                    # å·¥ä½œç©ºé—´è®¾ç½®å’Œéš”ç¦»
â”‚   â”‚
â”‚   â”œâ”€â”€ scheduling/                         # ğŸ“… ä»»åŠ¡è°ƒåº¦å’Œè‡ªåŠ¨ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ scheduler.py                    # æ™ºèƒ½è°ƒåº¦å™¨ï¼ˆä½¿ç”¨é…é¢ç®¡ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ auto_generator.py               # è‡ªåŠ¨ä»»åŠ¡ç”Ÿæˆï¼ˆä¸‰ç§ç­–ç•¥ï¼‰
â”‚   â”‚   â””â”€â”€ time_utils.py                   # æ—¶é—´å·¥å…·ï¼ˆç™½å¤©/å¤œé—´åˆ¤æ–­ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ monitoring/                         # ğŸ“Š ç›‘æ§å’Œæ€§èƒ½è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logging.py                      # æ—¥å¿—é…ç½®å’Œç®¡ç†
â”‚   â”‚   â”œâ”€â”€ monitor.py                      # ç³»ç»Ÿå¥åº·æ£€æŸ¥
â”‚   â”‚   â”œâ”€â”€ pro_plan_usage.py               # Claude Pro ä½¿ç”¨æƒ…å†µè¿½è¸ª
â”‚   â”‚   â””â”€â”€ report_generator.py             # æŠ¥å‘Šç”Ÿæˆï¼ˆæ—¥æŠ¥ã€é¡¹ç›®æŠ¥å‘Šï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/                              # ğŸ“‹ ä»»åŠ¡ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ refinement.py                   # ä»»åŠ¡ä¼˜åŒ–å’Œæ”¹è¿›é€»è¾‘
â”‚   â”‚   â””â”€â”€ utils.py                        # ä»»åŠ¡å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                              # ğŸ› ï¸ é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                       # é…ç½®åŠ è½½å’Œç®¡ç†
â”‚   â”‚   â”œâ”€â”€ directory_manager.py            # ç›®å½•ç®¡ç†å’Œæ¸…ç†
â”‚   â”‚   â”œâ”€â”€ display.py                      # ç»ˆç«¯æ˜¾ç¤ºå’Œæ ¼å¼åŒ–
â”‚   â”‚   â”œâ”€â”€ exceptions.py                   # è‡ªå®šä¹‰å¼‚å¸¸ç±»
â”‚   â”‚   â”œâ”€â”€ live_status.py                  # å®æ—¶çŠ¶æ€è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ metrics_aggregator.py           # æ€§èƒ½æŒ‡æ ‡èšåˆ
â”‚   â”‚   â””â”€â”€ readme_manager.py               # README è‡ªåŠ¨ç”Ÿæˆ
â”‚   â”‚
â”‚   â””â”€â”€ deployment/                         # ğŸš€ éƒ¨ç½²é…ç½®
â”‚       â”œâ”€â”€ sleepless-agent.service         # systemd æœåŠ¡é…ç½®ï¼ˆLinuxï¼‰
â”‚       â””â”€â”€ com.sleepless-agent.plist       # launchd é…ç½®ï¼ˆmacOSï¼‰
â”‚
â”œâ”€â”€ workspace/                              # ğŸ’¼ å·¥ä½œç©ºé—´ï¼ˆè¿è¡Œæ—¶æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ data/                               # æŒä¹…åŒ–æ•°æ®
â”‚   â”‚   â”œâ”€â”€ tasks.db                        # SQLite æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ results/                        # ä»»åŠ¡ç»“æœ JSON æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ reports/                        # æ¯æ—¥ Markdown æŠ¥å‘Š
â”‚   â”‚   â”œâ”€â”€ agent.log                       # åº”ç”¨æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ metrics.jsonl                   # æ€§èƒ½æŒ‡æ ‡ï¼ˆJSONL æ ¼å¼ï¼‰
â”‚   â”‚   â””â”€â”€ chat_sessions.json              # èŠå¤©ä¼šè¯çŠ¶æ€
â”‚   â”œâ”€â”€ tasks/                              # ä»»åŠ¡å·¥ä½œç©ºé—´ï¼ˆtask_1/, task_2/...ï¼‰
â”‚   â”œâ”€â”€ projects/                           # é¡¹ç›®å·¥ä½œç©ºé—´ï¼ˆä¸¥è‚ƒä»»åŠ¡ï¼‰
â”‚   â”œâ”€â”€ shared/                             # è·¨ä»»åŠ¡å…±äº«æ–‡ä»¶
â”‚   â””â”€â”€ trash/                              # è½¯åˆ é™¤çš„é¡¹ç›®
â”‚
â”œâ”€â”€ docs/                                   # ğŸ“– æ–‡æ¡£
â”‚   â”œâ”€â”€ index.md                            # æ–‡æ¡£ä¸»é¡µ
â”‚   â”œâ”€â”€ quickstart.md                       # å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ installation.md                     # å®‰è£…æŒ‡å—
â”‚   â”œâ”€â”€ troubleshooting.md                  # æ•…éšœæ’é™¤
â”‚   â”œâ”€â”€ faq.md                              # å¸¸è§é—®é¢˜
â”‚   â”œâ”€â”€ changelog.md                        # æ›´æ–°æ—¥å¿—
â”‚   â”‚
â”‚   â”œâ”€â”€ concepts/                           # æ¦‚å¿µæ–‡æ¡£
â”‚   â”‚   â”œâ”€â”€ architecture.md                 # æ¶æ„è¯´æ˜
â”‚   â”‚   â”œâ”€â”€ task-lifecycle.md               # ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”œâ”€â”€ workspace-isolation.md          # å·¥ä½œç©ºé—´éš”ç¦»
â”‚   â”‚   â”œâ”€â”€ pro-plan-management.md          # Pro è®¡åˆ’ç®¡ç†
â”‚   â”‚   â””â”€â”€ scheduling.md                   # è°ƒåº¦æœºåˆ¶
â”‚   â”‚
â”‚   â”œâ”€â”€ guides/                             # ä½¿ç”¨æŒ‡å—
â”‚   â”‚   â”œâ”€â”€ slack-setup.md                  # Slack è®¾ç½®
â”‚   â”‚   â”œâ”€â”€ environment-setup.md            # ç¯å¢ƒé…ç½®
â”‚   â”‚   â””â”€â”€ git-integration.md              # Git é›†æˆ
â”‚   â”‚
â”‚   â””â”€â”€ reference/                          # å‚è€ƒæ–‡æ¡£
â”‚       â””â”€â”€ api/cli-commands.md             # CLI å‘½ä»¤å‚è€ƒ
â”‚
â”œâ”€â”€ assets/                                 # é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€å›¾æ ‡ï¼‰
â”œâ”€â”€ .github/                                # GitHub é…ç½®ï¼ˆå·¥ä½œæµã€æ¨¡æ¿ï¼‰
â”œâ”€â”€ .env.example                            # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ pyproject.toml                          # Python é¡¹ç›®é…ç½®
â”œâ”€â”€ Makefile                                # å¼€å‘å’Œéƒ¨ç½²å‘½ä»¤
â”œâ”€â”€ mkdocs.yml                              # æ–‡æ¡£é…ç½®
â”œâ”€â”€ README.md                               # é¡¹ç›®è¯´æ˜ï¼ˆç”¨æˆ·æŒ‡å—ï¼‰
â”œâ”€â”€ CLAUDE.md                               # é¡¹ç›®ç»“æ„åˆ†æï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ CONTRIBUTING.md                         # è´¡çŒ®æŒ‡å—
â”œâ”€â”€ LICENSE                                 # MIT è®¸å¯è¯
â””â”€â”€ .gitignore                              # Git å¿½ç•¥è§„åˆ™
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. `core/daemon.py` - ä¸»äº‹ä»¶å¾ªç¯å’Œæ§åˆ¶å™¨

**æ ¸å¿ƒç±»ï¼š`SleeplessAgent`**

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¿ƒè„ï¼Œè´Ÿè´£æŒç»­è¿è¡Œå¹¶åè°ƒæ‰€æœ‰ç»„ä»¶ã€‚

**ä¸»è¦èŒè´£ï¼š**
- åˆå§‹åŒ–æ‰€æœ‰å­ç³»ç»Ÿï¼ˆSlack Botã€ä»»åŠ¡é˜Ÿåˆ—ã€è°ƒåº¦å™¨ï¼‰
- è¿è¡Œä¸»äº‹ä»¶å¾ªç¯ï¼ˆæ— é™å¾ªç¯ï¼Œå®šæœŸæ£€æŸ¥ä»»åŠ¡ï¼‰
- åè°ƒä»»åŠ¡æ‰§è¡Œå’Œè°ƒåº¦
- ç”Ÿæˆæ—¥æŠ¥å’ŒæŒ‡æ ‡æŠ¥å‘Š

**å…³é”®æ–¹æ³•ï¼š**

```python
class SleeplessAgent:
    def __init__(self, config: dict):
        """åˆå§‹åŒ–ä»£ç†å’Œæ‰€æœ‰å­ç³»ç»Ÿ"""
        self.config = config
        self.task_queue = TaskQueue(db_path)
        self.scheduler = SmartScheduler(config)
        self.executor = ClaudeCodeExecutor(config)
        self.git_manager = GitManager(config)

    async def run(self):
        """ä¸»äº‹ä»¶å¾ªç¯"""
        while True:
            # 1. æ£€æŸ¥ä½¿ç”¨é…é¢
            if not self.scheduler.should_generate_tasks():
                await asyncio.sleep(60)
                continue

            # 2. è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡
            task = self.task_queue.get_next_task()

            # 3. æ‰§è¡Œä»»åŠ¡
            if task:
                result = await self.executor.execute(task)
                self.task_queue.update_task(task.id, status='completed')

            # 4. è‡ªåŠ¨ç”Ÿæˆæ–°ä»»åŠ¡ï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
            if self.config['auto_generation']['enabled']:
                await self.auto_generate_task()

            # 5. ç”Ÿæˆæ—¥æŠ¥ï¼ˆæ¯å¤©å‡Œæ™¨ï¼‰
            if self._is_report_time():
                await self._generate_daily_report()
```

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ `asyncio` å®ç°å¼‚æ­¥æ‰§è¡Œ
- å†…ç½®é”™è¯¯æ¢å¤æœºåˆ¶ï¼ˆä»»åŠ¡å¤±è´¥æ—¶é‡è¯•ï¼‰
- æ”¯æŒä¼˜é›…å…³é—­ï¼ˆSIGTERM/SIGINT å¤„ç†ï¼‰

---

### 2. `core/executor.py` - Claude Code SDK æ‰§è¡Œå™¨

**æ ¸å¿ƒç±»ï¼š`ClaudeCodeExecutor`**

è¿™æ˜¯ä¸ Claude Code CLI äº¤äº’çš„å…³é”®æ¨¡å—ï¼Œä½¿ç”¨ Python Agent SDK è¿›è¡Œé€šä¿¡ã€‚

**ä¸»è¦èŒè´£ï¼š**
- è®¾ç½®éš”ç¦»å·¥ä½œç©ºé—´
- è°ƒç”¨ Claude Code SDK æ‰§è¡Œä»»åŠ¡
- å¤„ç†å·¥å…·ä½¿ç”¨ï¼ˆTool Useï¼‰å’Œå¤šè½®å¯¹è¯
- æ•è·å’Œè§£æè¾“å‡º
- ç®¡ç†è¶…æ—¶å’Œé”™è¯¯

**å…³é”®ç‰¹æ€§ï¼š**

```python
class ClaudeCodeExecutor:
    def __init__(self, config: dict):
        self.model = config['claude_code']['model']  # claude-sonnet-4-5-20250929
        self.timeout = config['agent']['task_timeout_seconds']

    async def execute(self, task: Task) -> Result:
        """æ‰§è¡Œå•ä¸ªä»»åŠ¡"""
        # 1. è®¾ç½®å·¥ä½œç©ºé—´
        workspace = self._setup_workspace(task)

        # 2. æ„å»ºæç¤º
        prompt = self._build_prompt(task)

        # 3. è°ƒç”¨ Claude Agent SDK
        try:
            response = await self._query_claude(
                prompt=prompt,
                workspace=workspace,
                max_turns=self.config['multi_agent_workflow']['worker']['max_turns']
            )

            # 4. è§£æå“åº”
            result = self._parse_response(response)

            # 5. ä¿å­˜ç»“æœ
            self._save_result(task, result)

            return result
        except TimeoutError:
            return Result(status='failed', error='Task timeout')
```

**å·¥ä½œç©ºé—´éš”ç¦»æœºåˆ¶ï¼š**
- æ¯ä¸ªä»»åŠ¡åœ¨ `workspace/tasks/<task_id>/` æˆ– `workspace/projects/<project_name>/` ä¸­æ‰§è¡Œ
- ä»»åŠ¡åªèƒ½è®¿é—®è‡ªå·±çš„å·¥ä½œç©ºé—´å’Œ `workspace/shared/`
- ç³»ç»Ÿç›®å½•ï¼ˆ`workspace/data/`ï¼‰å—ä¿æŠ¤

---

### 3. `core/queue.py` - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

**æ ¸å¿ƒç±»ï¼š`TaskQueue`**

åŸºäº SQLite çš„æŒä¹…åŒ–ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒä¼˜å…ˆçº§è°ƒåº¦å’Œ CRUD æ“ä½œã€‚

**æ•°æ®æ¨¡å‹ï¼ˆè§ `core/models.py`ï¼‰ï¼š**

```python
class Task(Base):
    __tablename__ = 'tasks'

    id = Column(Integer, primary_key=True)
    description = Column(String, nullable=False)
    priority = Column(Enum(TaskPriority))  # THOUGHT, SERIOUS, GENERATED
    status = Column(Enum(TaskStatus))      # PENDING, IN_PROGRESS, COMPLETED, FAILED
    task_type = Column(Enum(TaskType))     # NEW, REFINE
    project_name = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    started_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
```

**å…³é”®æ–¹æ³•ï¼š**

```python
class TaskQueue:
    def add_task(self, description: str, priority: TaskPriority,
                 project_name: str = None) -> Task:
        """æ·»åŠ æ–°ä»»åŠ¡åˆ°é˜Ÿåˆ—"""

    def get_next_task(self) -> Optional[Task]:
        """è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼ˆåŸºäºä¼˜å…ˆçº§ï¼‰"""
        # ä¼˜å…ˆçº§é¡ºåºï¼šSERIOUS > THOUGHT > GENERATED

    def update_task_status(self, task_id: int, status: TaskStatus):
        """æ›´æ–°ä»»åŠ¡çŠ¶æ€"""

    def get_tasks_by_project(self, project_name: str) -> List[Task]:
        """è·å–é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡"""
```

**ä¼˜å…ˆçº§ç­–ç•¥ï¼š**
1. **SERIOUSï¼ˆä¸¥è‚ƒä»»åŠ¡ï¼‰**ï¼šæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¸¦ `-p` æ ‡å¿—çš„ä»»åŠ¡
2. **THOUGHTï¼ˆéšæœºæƒ³æ³•ï¼‰**ï¼šä¸­ç­‰ä¼˜å…ˆçº§ï¼Œå¿«é€Ÿå¤„ç†
3. **GENERATEDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰**ï¼šæœ€ä½ä¼˜å…ˆçº§ï¼Œå¡«å……ç©ºé—²æ—¶é—´

---

### 4. `interfaces/bot.py` - Slack é›†æˆ

**æ ¸å¿ƒç±»ï¼š`SlackBot`**

ä½¿ç”¨ Slack Bolt SDK å¤„ç†æ–œæ å‘½ä»¤å’Œæ¶ˆæ¯äº‹ä»¶ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- Socket Mode è¿æ¥ï¼ˆæ— éœ€å…¬ç½‘ URLï¼‰
- æ–œæ å‘½ä»¤å¤„ç†ï¼ˆ`/think`, `/check`, `/usage` ç­‰ï¼‰
- èŠå¤©æ¨¡å¼é›†æˆï¼ˆçº¿ç¨‹æ¶ˆæ¯ç›‘å¬ï¼‰
- å®æ—¶çŠ¶æ€åé¦ˆï¼ˆemoji ååº”ã€çŠ¶æ€æ›´æ–°ï¼‰

**å‘½ä»¤å¤„ç†ç¤ºä¾‹ï¼š**

```python
from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler

app = App(token=os.environ["SLACK_BOT_TOKEN"])

@app.command("/think")
def handle_think(ack, command, client):
    """å¤„ç† /think å‘½ä»¤"""
    ack()  # ç«‹å³ç¡®è®¤å‘½ä»¤

    text = command['text']

    # è§£æå‚æ•°
    if '-p' in text:
        # ä¸¥è‚ƒä»»åŠ¡
        parts = text.split('-p')
        description = parts[0].strip()
        project = parts[1].strip()
        priority = TaskPriority.SERIOUS
    else:
        # éšæœºæƒ³æ³•
        description = text
        project = None
        priority = TaskPriority.THOUGHT

    # æ·»åŠ åˆ°é˜Ÿåˆ—
    task = task_queue.add_task(description, priority, project)

    # å›å¤ç”¨æˆ·
    client.chat_postMessage(
        channel=command['channel_id'],
        text=f"âœ… ä»»åŠ¡å·²æ·»åŠ åˆ°é˜Ÿåˆ— (ID: {task.id})"
    )

@app.command("/check")
def handle_check(ack, command, client):
    """å¤„ç† /check å‘½ä»¤"""
    ack()

    # è·å–ç³»ç»ŸçŠ¶æ€
    status = daemon.get_status()

    # æ ¼å¼åŒ–è¾“å‡º
    message = f"""
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ System Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸŸ¢ Daemon: {status['daemon_status']}
â”‚ ğŸ“Š Queue: {status['pending_tasks']} pending, {status['in_progress_tasks']} in_progress
â”‚ ğŸ’» Usage: {status['usage_percent']}% (Threshold: {status['threshold']}%)
â”‚ ğŸ”„ Last task: "{status['last_task']}" ({status['last_task_status']})
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    """

    client.chat_postMessage(channel=command['channel_id'], text=message)
```

---

### 5. `storage/git.py` - Git è‡ªåŠ¨åŒ–

**æ ¸å¿ƒç±»ï¼š`GitManager`**

ä½¿ç”¨ GitPython å®ç° Git æ“ä½œè‡ªåŠ¨åŒ–ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯ï¼ˆ`thought-ideas` æˆ– `feature/<project>-<task_id>`ï¼‰
- è‡ªåŠ¨æäº¤ï¼ˆå¸¦æè¿°æ€§æ¶ˆæ¯ï¼‰
- è‡ªåŠ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“
- è‡ªåŠ¨åˆ›å»º Pull Requestï¼ˆä½¿ç”¨ `gh` CLIï¼‰

**å·¥ä½œæµç¤ºä¾‹ï¼š**

```python
class GitManager:
    def commit_task_result(self, task: Task, result: Result):
        """æäº¤ä»»åŠ¡ç»“æœåˆ° Git"""

        if task.priority == TaskPriority.THOUGHT:
            # éšæœºæƒ³æ³• -> thought-ideas åˆ†æ”¯
            branch = 'thought-ideas'
            self._ensure_branch(branch)
            self._commit_changes(
                message=f"ğŸ’¡ Thought: {task.description}",
                branch=branch
            )
        elif task.priority == TaskPriority.SERIOUS:
            # ä¸¥è‚ƒä»»åŠ¡ -> åŠŸèƒ½åˆ†æ”¯ + PR
            branch = f"feature/{task.project_name}-{task.id}"
            self._create_branch(branch)
            self._commit_changes(
                message=f"âœ¨ {task.description}",
                branch=branch
            )
            self._create_pull_request(
                branch=branch,
                title=task.description,
                project=task.project_name
            )

    def _create_pull_request(self, branch: str, title: str, project: str):
        """ä½¿ç”¨ gh CLI åˆ›å»º PR"""
        subprocess.run([
            'gh', 'pr', 'create',
            '--title', title,
            '--body', f"Project: {project}\n\nAuto-generated by Sleepless Agent",
            '--head', branch,
            '--base', 'main'
        ])
```

---

### 6. `scheduling/scheduler.py` - æ™ºèƒ½è°ƒåº¦

**æ ¸å¿ƒç±»ï¼š`SmartScheduler` å’Œ `BudgetManager`**

åŸºäºæ—¶é—´å’Œä½¿ç”¨é…é¢çš„æ™ºèƒ½è°ƒåº¦ç³»ç»Ÿã€‚

**å…³é”®ç‰¹æ€§ï¼š**
- æ—¶é—´æ„ŸçŸ¥ï¼ˆç™½å¤© vs å¤œé—´ï¼‰
- ä½¿ç”¨é…é¢ç›‘æ§ï¼ˆé€šè¿‡ `claude /usage` å‘½ä»¤ï¼‰
- åŠ¨æ€é˜ˆå€¼è°ƒæ•´
- ä»»åŠ¡ç”Ÿæˆæ§åˆ¶

**é…é¢ç®¡ç†é€»è¾‘ï¼š**

```python
class BudgetManager:
    def __init__(self, config: dict):
        self.threshold_day = config['claude_code']['threshold_day']      # 95%
        self.threshold_night = config['claude_code']['threshold_night']  # 96%
        self.night_start = config['claude_code']['night_start_hour']    # 1
        self.night_end = config['claude_code']['night_end_hour']        # 9

    def get_current_usage(self) -> float:
        """è·å–å½“å‰ä½¿ç”¨ç™¾åˆ†æ¯”"""
        result = subprocess.run(['claude', '/usage'], capture_output=True, text=True)
        # è§£æè¾“å‡ºï¼Œæå–ä½¿ç”¨ç™¾åˆ†æ¯”
        return self._parse_usage(result.stdout)

    def should_allow_task_generation(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦å…è®¸ç”Ÿæˆæ–°ä»»åŠ¡"""
        usage = self.get_current_usage()
        threshold = self._get_current_threshold()

        return usage < threshold

    def _get_current_threshold(self) -> float:
        """æ ¹æ®æ—¶é—´è¿”å›é€‚å½“çš„é˜ˆå€¼"""
        current_hour = datetime.now().hour
        if self.night_start <= current_hour < self.night_end:
            return self.threshold_night  # å¤œé—´æ›´æ¿€è¿›
        else:
            return self.threshold_day     # ç™½å¤©ä¿å®ˆ
```

---

### 7. `chat/handler.py` - äº¤äº’å¼èŠå¤©æ¨¡å¼

**æ ¸å¿ƒç±»ï¼š`ChatHandler`**

ç®¡ç† Slack çº¿ç¨‹ä¸­çš„å®æ—¶å¯¹è¯ã€‚

**å…³é”®ç‰¹æ€§ï¼š**
- ä¼šè¯éš”ç¦»ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªä¼šè¯ï¼‰
- å¯¹è¯å†å²ç»´æŠ¤
- 30 åˆ†é’Ÿä¸æ´»åŠ¨è¶…æ—¶
- å®æ—¶å¤„ç†æŒ‡ç¤ºå™¨ï¼ˆemoji ååº”ï¼‰

**ä¼šè¯ç®¡ç†ï¼š**

```python
class ChatSession:
    def __init__(self, project: str, thread_ts: str):
        self.project = project
        self.thread_ts = thread_ts  # Slack çº¿ç¨‹ ID
        self.history = []           # å¯¹è¯å†å²
        self.last_activity = datetime.now()

    def add_message(self, role: str, content: str):
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²"""
        self.history.append({"role": role, "content": content})
        self.last_activity = datetime.now()

    def is_expired(self) -> bool:
        """æ£€æŸ¥ä¼šè¯æ˜¯å¦è¶…æ—¶"""
        return (datetime.now() - self.last_activity).seconds > 1800  # 30 åˆ†é’Ÿ

class ChatHandler:
    def handle_message(self, message: dict, client):
        """å¤„ç†èŠå¤©æ¶ˆæ¯"""
        thread_ts = message['thread_ts']
        session = self.sessions.get(thread_ts)

        if not session or session.is_expired():
            client.chat_postMessage(
                channel=message['channel'],
                thread_ts=thread_ts,
                text="âŒ ä¼šè¯å·²è¿‡æœŸï¼Œè¯·ä½¿ç”¨ /chat <project> é‡æ–°å¼€å§‹"
            )
            return

        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
        session.add_message("user", message['text'])

        # è°ƒç”¨ Claudeï¼ˆå¸¦å†å²ï¼‰
        response = self.executor.chat(
            prompt=message['text'],
            history=session.history,
            workspace=f"workspace/projects/{session.project}"
        )

        # æ·»åŠ åŠ©æ‰‹å“åº”åˆ°å†å²
        session.add_message("assistant", response)

        # å›å¤åˆ°çº¿ç¨‹
        client.chat_postMessage(
            channel=message['channel'],
            thread_ts=thread_ts,
            text=response
        )
```

---

## æ•°æ®æµå’Œæ¶æ„

### å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·ç•Œé¢å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Slack Bot       â”‚  CLI (sle)                                    â”‚
â”‚  - /think        â”‚  - think <desc> -p <project>                  â”‚
â”‚  - /check        â”‚  - check                                      â”‚
â”‚  - /chat         â”‚  - report [id]                                â”‚
â”‚  - /usage        â”‚  - cancel <id>                                â”‚
â”‚  - /report       â”‚  - trash [subcmd]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         v                             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ ¸å¿ƒæ§åˆ¶å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  SleeplessAgent (daemon.py)                            â”‚     â”‚
â”‚  â”‚  - ä¸»äº‹ä»¶å¾ªç¯                                           â”‚     â”‚
â”‚  â”‚  - ä»»åŠ¡åè°ƒ                                             â”‚     â”‚
â”‚  â”‚  - å­ç³»ç»Ÿç®¡ç†                                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        v                 v                 v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaskQueue    â”‚  â”‚  Scheduler   â”‚  â”‚  ClaudeExecutor     â”‚
â”‚  (queue.py)   â”‚  â”‚ (scheduler.py)â”‚  â”‚  (executor.py)      â”‚
â”‚               â”‚  â”‚               â”‚  â”‚                     â”‚
â”‚  - CRUD       â”‚  â”‚  - ä½¿ç”¨ç›‘æ§  â”‚  â”‚  - SDK è°ƒç”¨         â”‚
â”‚  - ä¼˜å…ˆçº§     â”‚  â”‚  - é˜ˆå€¼ç®¡ç†  â”‚  â”‚  - å·¥ä½œç©ºé—´éš”ç¦»     â”‚
â”‚  - æŒä¹…åŒ–     â”‚  â”‚  - æ—¶é—´æ„ŸçŸ¥  â”‚  â”‚  - å¤šè½®å¯¹è¯         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                     â”‚
        v                 v                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å­˜å‚¨å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SQLite DB   â”‚  â”‚  File System â”‚  â”‚  Git Repository    â”‚    â”‚
â”‚  â”‚  (tasks.db)  â”‚  â”‚  (results/)  â”‚  â”‚  (remote)          â”‚    â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                    â”‚    â”‚
â”‚  â”‚  - Tasks     â”‚  â”‚  - Results   â”‚  â”‚  - Branches        â”‚    â”‚
â”‚  â”‚  - Results   â”‚  â”‚  - Reports   â”‚  â”‚  - Commits         â”‚    â”‚
â”‚  â”‚  - Metadata  â”‚  â”‚  - Logs      â”‚  â”‚  - Pull Requests   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾

```
1. ä»»åŠ¡åˆ›å»º (Task Creation)
   â†“
   â”œâ”€ æ¥æº A: Slack å‘½ä»¤ (/think)
   â”œâ”€ æ¥æº B: CLI å‘½ä»¤ (sle think)
   â””â”€ æ¥æº C: è‡ªåŠ¨ç”Ÿæˆ (AutoGenerator)
   â†“
2. å…¥é˜Ÿ (Enqueue)
   â†“
   TaskQueue.add_task()
   â†“
   å†™å…¥ SQLite (status=PENDING)
   â†“
3. è°ƒåº¦æ£€æŸ¥ (Scheduling Check)
   â†“
   SmartScheduler.should_generate_tasks()
   â†“
   â”œâ”€ æ£€æŸ¥ä½¿ç”¨é…é¢ (claude /usage)
   â”œâ”€ æ£€æŸ¥æ—¶é—´çª—å£ (ç™½å¤©/å¤œé—´)
   â””â”€ æ£€æŸ¥é˜ˆå€¼ (95% or 96%)
   â†“
   [å¦‚æœè¶…è¿‡é˜ˆå€¼] â†’ æš‚åœï¼Œç­‰å¾…é‡ç½®
   [å¦‚æœæœªè¶…è¿‡] â†’ ç»§ç»­
   â†“
4. ä»»åŠ¡é€‰æ‹© (Task Selection)
   â†“
   TaskQueue.get_next_task()
   â†“
   ä¼˜å…ˆçº§æ’åºï¼šSERIOUS > THOUGHT > GENERATED
   â†“
5. å·¥ä½œç©ºé—´è®¾ç½® (Workspace Setup)
   â†“
   â”œâ”€ åˆ›å»ºéš”ç¦»ç›®å½• (workspace/tasks/<id>/ æˆ– projects/<name>/)
   â”œâ”€ è®¾ç½®æƒé™å’Œè¾¹ç•Œ
   â””â”€ åˆå§‹åŒ– Gitï¼ˆå¦‚æœéœ€è¦ï¼‰
   â†“
6. æ‰§è¡Œ (Execution)
   â†“
   ClaudeCodeExecutor.execute(task)
   â†“
   â”œâ”€ [å¤šä»£ç†å·¥ä½œæµå¯ç”¨?]
   â”‚   â”œâ”€ Phase 1: Planner Agent (åˆ†æä»»åŠ¡)
   â”‚   â”œâ”€ Phase 2: Worker Agent (æ‰§è¡Œä»»åŠ¡)
   â”‚   â””â”€ Phase 3: Evaluator Agent (éªŒè¯ç»“æœ)
   â”‚
   â””â”€ [ç›´æ¥æ‰§è¡Œæ¨¡å¼]
       â””â”€ å•è½®æˆ–å¤šè½®å¯¹è¯
   â†“
7. ç»“æœå¤„ç† (Result Processing)
   â†“
   â”œâ”€ ä¿å­˜ç»“æœ JSON (workspace/data/results/<id>.json)
   â”œâ”€ æ›´æ–°ä»»åŠ¡çŠ¶æ€ (status=COMPLETED or FAILED)
   â”œâ”€ è®°å½•æŒ‡æ ‡ (metrics.jsonl)
   â””â”€ ç”ŸæˆæŠ¥å‘Šï¼ˆå¦‚æœéœ€è¦ï¼‰
   â†“
8. Git é›†æˆ (Git Integration)
   â†“
   GitManager.commit_task_result()
   â†“
   â”œâ”€ [THOUGHT ä»»åŠ¡]
   â”‚   â”œâ”€ åˆ‡æ¢åˆ° thought-ideas åˆ†æ”¯
   â”‚   â”œâ”€ æäº¤æ›´æ”¹
   â”‚   â””â”€ æ¨é€åˆ°è¿œç¨‹
   â”‚
   â””â”€ [SERIOUS ä»»åŠ¡]
       â”œâ”€ åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (feature/<project>-<id>)
       â”œâ”€ æäº¤æ›´æ”¹
       â”œâ”€ æ¨é€åˆ°è¿œç¨‹
       â””â”€ åˆ›å»º Pull Request (gh pr create)
   â†“
9. é€šçŸ¥ (Notification)
   â†“
   â”œâ”€ Slack æ¶ˆæ¯ï¼ˆä»»åŠ¡å®Œæˆé€šçŸ¥ï¼‰
   â””â”€ æ—¥å¿—è®°å½•ï¼ˆagent.logï¼‰
   â†“
10. æ¸…ç† (Cleanup)
    â†“
    â”œâ”€ å¯é€‰ï¼šå½’æ¡£å·¥ä½œç©ºé—´
    â””â”€ æ›´æ–°ç»Ÿè®¡æ•°æ®
```

### æ•°æ®æµå‘è¯´æ˜

**ç”¨æˆ·äº¤äº’ â†’ ä»»åŠ¡é˜Ÿåˆ—ï¼š**
1. ç”¨æˆ·é€šè¿‡ Slack æˆ– CLI æäº¤ä»»åŠ¡
2. å‘½ä»¤è§£æå™¨æå–æè¿°ã€ä¼˜å…ˆçº§ã€é¡¹ç›®å
3. åˆ›å»º Task å¯¹è±¡å¹¶å†™å…¥ SQLite

**ä»»åŠ¡é˜Ÿåˆ— â†’ æ‰§è¡Œå™¨ï¼š**
1. å®ˆæŠ¤è¿›ç¨‹ä»é˜Ÿåˆ—è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆåŸºäºä¼˜å…ˆçº§ï¼‰
2. è°ƒåº¦å™¨æ£€æŸ¥æ˜¯å¦å…è®¸æ‰§è¡Œï¼ˆä½¿ç”¨é…é¢ï¼‰
3. å¦‚æœå…è®¸ï¼Œä»»åŠ¡ä¼ é€’ç»™æ‰§è¡Œå™¨

**æ‰§è¡Œå™¨ â†’ Claude Code SDKï¼š**
1. æ‰§è¡Œå™¨è®¾ç½®å·¥ä½œç©ºé—´ç¯å¢ƒ
2. æ„å»ºæç¤ºï¼ˆåŒ…å«ä»»åŠ¡æè¿°ã€ä¸Šä¸‹æ–‡ï¼‰
3. è°ƒç”¨ Claude Agent SDK
4. å¤„ç†å·¥å…·ä½¿ç”¨å’Œå¤šè½®å¯¹è¯
5. è§£ææœ€ç»ˆå“åº”

**æ‰§è¡Œå™¨ â†’ å­˜å‚¨å±‚ï¼š**
1. ç»“æœä¿å­˜ä¸º JSON æ–‡ä»¶
2. ä»»åŠ¡çŠ¶æ€æ›´æ–°åˆ°æ•°æ®åº“
3. æŒ‡æ ‡å†™å…¥ metrics.jsonl
4. å¦‚æœå¯ç”¨ï¼Œæ›´æ”¹æäº¤åˆ° Git

---

## é…ç½®ç³»ç»Ÿè¯¦è§£

### `config.yaml` å®Œæ•´é…ç½®é¡¹

```yaml
# Claude Code é…ç½®
claude_code:
  binary_path: claude                        # Claude CLI å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
  model: claude-sonnet-4-5-20250929         # ä½¿ç”¨çš„æ¨¡å‹
  night_start_hour: 1                       # å¤œé—´å¼€å§‹æ—¶é—´ï¼ˆå‡Œæ™¨ 1 ç‚¹ï¼‰
  night_end_hour: 9                         # å¤œé—´ç»“æŸæ—¶é—´ï¼ˆä¸Šåˆ 9 ç‚¹ï¼‰
  threshold_day: 20.0                       # ç™½å¤©ä½¿ç”¨é˜ˆå€¼ï¼ˆ95%ï¼‰
  threshold_night: 80.0                     # å¤œé—´ä½¿ç”¨é˜ˆå€¼ï¼ˆ96%ï¼‰
  usage_command: claude /usage              # ä½¿ç”¨æƒ…å†µæŸ¥è¯¢å‘½ä»¤

# ä»£ç†é…ç½®
agent:
  workspace_root: ./workspace               # å·¥ä½œç©ºé—´æ ¹ç›®å½•
  task_timeout_seconds: 1800                # ä»»åŠ¡è¶…æ—¶ï¼ˆ30 åˆ†é’Ÿï¼‰
  max_concurrent_tasks: 1                   # æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°

# Git é…ç½®
git:
  enabled: false                             # æ˜¯å¦å¯ç”¨ Git é›†æˆ
  use_remote_repo: true                     # æ˜¯å¦ä½¿ç”¨è¿œç¨‹ä»“åº“
  remote_repo_url: git@github.com:user/repo.git  # è¿œç¨‹ä»“åº“ URL
  auto_create_repo: true                    # è‡ªåŠ¨åˆ›å»ºä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  thought_branch: thought-ideas             # éšæœºæƒ³æ³•åˆ†æ”¯å
  auto_commit: true                         # è‡ªåŠ¨æäº¤
  auto_push: true                           # è‡ªåŠ¨æ¨é€
  auto_pr: true                             # è‡ªåŠ¨åˆ›å»º PRï¼ˆä¸¥è‚ƒä»»åŠ¡ï¼‰

# å¤šä»£ç†å·¥ä½œæµé…ç½®
multi_agent_workflow:
  enabled: true                             # æ˜¯å¦å¯ç”¨å¤šä»£ç†å·¥ä½œæµ

  planner:
    enabled: true                           # æ˜¯å¦å¯ç”¨ Planner Agent
    max_turns: 10                            # æœ€å¤§è½®æ¬¡
    prompt_template: |                      # Planner æç¤ºæ¨¡æ¿
      You are a planning agent. Analyze the following task and create a detailed execution plan:

      Task: {task_description}

      Provide:
      1. Step-by-step plan
      2. Potential challenges
      3. Required resources

  worker:
    enabled: true                           # æ˜¯å¦å¯ç”¨ Worker Agent
    max_turns: 30                            # æœ€å¤§è½®æ¬¡
    prompt_template: |                      # Worker æç¤ºæ¨¡æ¿
      You are a worker agent. Execute the following task based on the plan:

      Task: {task_description}
      Plan: {plan}

      Complete the task and provide results.

  evaluator:
    enabled: true                           # æ˜¯å¦å¯ç”¨ Evaluator Agent
    max_turns: 10                            # æœ€å¤§è½®æ¬¡
    prompt_template: |                      # Evaluator æç¤ºæ¨¡æ¿
      You are an evaluator agent. Review the completed work:

      Task: {task_description}
      Result: {result}

      Validate:
      1. Correctness
      2. Completeness
      3. Code quality

# ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆé…ç½®
auto_generation:
  enabled: true                             # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä»»åŠ¡ç”Ÿæˆ
  interval_seconds: 300                     # ç”Ÿæˆé—´éš”ï¼ˆ5 åˆ†é’Ÿï¼‰
  max_generated_tasks: 10                   # æœ€å¤§è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡æ•°

  strategies:                               # ç”Ÿæˆç­–ç•¥ï¼ˆæƒé‡æ€»å’Œåº”ä¸º 100ï¼‰
    refine_focused: 45                      # æ”¹è¿›ç°æœ‰å·¥ä½œï¼ˆ45%ï¼‰
    balanced: 35                            # æ··åˆç­–ç•¥ï¼ˆ35%ï¼‰
    new_friendly: 20                        # åˆ›å»ºæ–°é¡¹ç›®ï¼ˆ20%ï¼‰

# ç›‘æ§å’Œæ—¥å¿—é…ç½®
monitoring:
  log_level: INFO                           # æ—¥å¿—çº§åˆ«ï¼ˆDEBUG, INFO, WARNING, ERRORï¼‰
  log_file: workspace/data/agent.log        # æ—¥å¿—æ–‡ä»¶è·¯å¾„
  metrics_file: workspace/data/metrics.jsonl  # æŒ‡æ ‡æ–‡ä»¶è·¯å¾„

  daily_report:
    enabled: true                           # æ˜¯å¦ç”Ÿæˆæ—¥æŠ¥
    time: "09:00"                           # ç”Ÿæˆæ—¶é—´ï¼ˆæ¯å¤©ä¸Šåˆ 9 ç‚¹ï¼‰
    slack_channel: "#sleepless-reports"     # å‘é€åˆ°çš„ Slack é¢‘é“

# Slack é…ç½®ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ï¼‰
# SLACK_BOT_TOKEN, SLACK_APP_TOKEN

# æ•°æ®åº“é…ç½®
database:
  path: workspace/data/tasks.db             # SQLite æ•°æ®åº“è·¯å¾„
  backup_enabled: true                      # æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¤‡ä»½
  backup_interval_hours: 24                 # å¤‡ä»½é—´éš”ï¼ˆ24 å°æ—¶ï¼‰
```

### ç¯å¢ƒå˜é‡

```bash
# å¿…éœ€
SLACK_BOT_TOKEN=xoxb-...                    # Slack Bot ä»¤ç‰Œ
SLACK_APP_TOKEN=xapp-...                    # Slack App ä»¤ç‰Œ

# å¯é€‰ï¼ˆè¦†ç›– config.yamlï¼‰
AGENT_WORKSPACE_ROOT=./workspace            # å·¥ä½œç©ºé—´æ ¹ç›®å½•
AGENT_DB_PATH=./workspace/data/tasks.db     # æ•°æ®åº“è·¯å¾„
AGENT_RESULTS_PATH=./workspace/data/results # ç»“æœç›®å½•
LOG_LEVEL=INFO                              # æ—¥å¿—çº§åˆ«
SLEEPLESS_LOG_LEVEL=DEBUG                   # Sleepless ä¸“ç”¨æ—¥å¿—çº§åˆ«

# Claude Codeï¼ˆå¦‚æœéœ€è¦è¦†ç›–ï¼‰
CLAUDE_BINARY_PATH=claude                   # Claude CLI è·¯å¾„
CLAUDE_MODEL=claude-sonnet-4-5-20250929     # æ¨¡å‹åç§°
```

### å·¥ä½œç©ºé—´ç»“æ„è¯¦è§£

```
workspace/
â”œâ”€â”€ data/                                   # æŒä¹…åŒ–æ•°æ®ï¼ˆç³»ç»Ÿï¼‰
â”‚   â”œâ”€â”€ tasks.db                            # SQLite æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ è¡¨ï¼štasks, results, metadata
â”‚   â”‚
â”‚   â”œâ”€â”€ results/                            # ä»»åŠ¡ç»“æœ JSON
â”‚   â”‚   â”œâ”€â”€ task_1.json
â”‚   â”‚   â”œâ”€â”€ task_2.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ reports/                            # æ—¥æŠ¥ Markdown
â”‚   â”‚   â”œâ”€â”€ 2025-10-22.md
â”‚   â”‚   â”œâ”€â”€ 2025-10-23.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ agent.log                           # åº”ç”¨æ—¥å¿—
â”‚   â”œâ”€â”€ metrics.jsonl                       # æ€§èƒ½æŒ‡æ ‡ï¼ˆæ¯è¡Œä¸€ä¸ª JSONï¼‰
â”‚   â””â”€â”€ chat_sessions.json                  # èŠå¤©ä¼šè¯çŠ¶æ€
â”‚
â”œâ”€â”€ tasks/                                  # ä»»åŠ¡å·¥ä½œç©ºé—´ï¼ˆéš”ç¦»ï¼‰
â”‚   â”œâ”€â”€ task_1/                             # ä»»åŠ¡ 1 çš„å·¥ä½œç›®å½•
â”‚   â”‚   â”œâ”€â”€ main.py                         # ç”Ÿæˆçš„ä»£ç æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ .claude/                        # Claude å…ƒæ•°æ®
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ task_2/
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ projects/                               # é¡¹ç›®å·¥ä½œç©ºé—´ï¼ˆä¸¥è‚ƒä»»åŠ¡ï¼‰
â”‚   â”œâ”€â”€ backend/                            # é¡¹ç›®åç§°
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ .git/                           # é¡¹ç›®çš„ Git ä»“åº“
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ shared/                                 # è·¨ä»»åŠ¡å…±äº«æ–‡ä»¶
â”‚   â”œâ”€â”€ libraries/                          # å…±äº«åº“
â”‚   â”œâ”€â”€ templates/                          # ä»£ç æ¨¡æ¿
â”‚   â””â”€â”€ utils/                              # å·¥å…·è„šæœ¬
â”‚
â””â”€â”€ trash/                                  # è½¯åˆ é™¤çš„é¡¹ç›®
    â”œâ”€â”€ backend_deleted_2025-10-22/
    â””â”€â”€ ...
```

---

## å…³é”®åŠŸèƒ½å®ç°åŸç†

### 1. 24/7 å®ˆæŠ¤è¿›ç¨‹æœºåˆ¶

**å®ç°åŸç†ï¼š**

å®ˆæŠ¤è¿›ç¨‹åŸºäº Python çš„ `asyncio` äº‹ä»¶å¾ªç¯å®ç°ï¼Œä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯ï¼š

```python
import asyncio
import signal

class SleeplessAgent:
    def __init__(self):
        self.running = True
        self.setup_signal_handlers()

    def setup_signal_handlers(self):
        """è®¾ç½®ä¿¡å·å¤„ç†å™¨ä»¥æ”¯æŒä¼˜é›…å…³é—­"""
        signal.signal(signal.SIGTERM, self.handle_shutdown)
        signal.signal(signal.SIGINT, self.handle_shutdown)

    def handle_shutdown(self, signum, frame):
        """å¤„ç†å…³é—­ä¿¡å·"""
        logger.info(f"Received signal {signum}, shutting down gracefully...")
        self.running = False

    async def run(self):
        """ä¸»äº‹ä»¶å¾ªç¯"""
        logger.info("Sleepless Agent starting...")

        # å¯åŠ¨å­ç³»ç»Ÿ
        await self.start_slack_bot()

        # ä¸»å¾ªç¯
        while self.running:
            try:
                # 1. æ£€æŸ¥ä½¿ç”¨é…é¢
                if not self.scheduler.should_generate_tasks():
                    await asyncio.sleep(60)
                    continue

                # 2. å¤„ç†ä»»åŠ¡
                await self.process_next_task()

                # 3. è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡
                if self.should_auto_generate():
                    await self.auto_generate_task()

                # 4. ç”ŸæˆæŠ¥å‘Š
                if self.is_report_time():
                    await self.generate_daily_report()

                # çŸ­æš‚ä¼‘çœ 
                await asyncio.sleep(10)

            except Exception as e:
                logger.error(f"Error in main loop: {e}")
                await asyncio.sleep(60)  # é”™è¯¯åç­‰å¾…

        # æ¸…ç†
        await self.cleanup()
        logger.info("Sleepless Agent stopped")

# éƒ¨ç½²ä¸º systemd æœåŠ¡ï¼ˆLinuxï¼‰
[Unit]
Description=Sleepless Agent - 24/7 AI Assistant
After=network.target

[Service]
Type=simple
User=sleepless
WorkingDirectory=/opt/sleepless-agent
ExecStart=/opt/sleepless-agent/venv/bin/python -m sleepless_agent.core.daemon
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**å…³é”®ç‰¹æ€§ï¼š**
- **æŒç»­è¿è¡Œ**ï¼šæ— é™å¾ªç¯ + ä¼˜é›…å…³é—­
- **é”™è¯¯æ¢å¤**ï¼šæ•è·å¼‚å¸¸å¹¶è‡ªåŠ¨é‡è¯•
- **èµ„æºç®¡ç†**ï¼šå®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—è½®è½¬
- **è‡ªåŠ¨é‡å¯**ï¼šé€šè¿‡ systemd æˆ– launchd å®ç°å´©æºƒåé‡å¯

---

### 2. æ™ºèƒ½è°ƒåº¦ç®—æ³•ï¼ˆåŸºäºæ—¶é—´å’Œé…é¢ï¼‰

**æ ¸å¿ƒé€»è¾‘ï¼š**

```python
class SmartScheduler:
    def should_generate_tasks(self) -> bool:
        """å†³å®šæ˜¯å¦åº”è¯¥ç”Ÿæˆæ–°ä»»åŠ¡"""
        # 1. è·å–å½“å‰ä½¿ç”¨æƒ…å†µ
        usage_percent = self.budget_manager.get_current_usage()

        # 2. è·å–å½“å‰é€‚ç”¨çš„é˜ˆå€¼
        threshold = self._get_time_based_threshold()

        # 3. æ¯”è¾ƒ
        if usage_percent >= threshold:
            logger.info(f"Usage {usage_percent}% >= threshold {threshold}%, pausing task generation")
            return False

        return True

    def _get_time_based_threshold(self) -> float:
        """æ ¹æ®å½“å‰æ—¶é—´è¿”å›é€‚å½“çš„é˜ˆå€¼"""
        current_hour = datetime.now().hour

        # å¤œé—´ï¼ˆ1:00 - 9:00ï¼‰
        if self.config['night_start_hour'] <= current_hour < self.config['night_end_hour']:
            return self.config['threshold_night']  # 96% - æ›´æ¿€è¿›

        # ç™½å¤©ï¼ˆ9:00 - 1:00ï¼‰
        else:
            return self.config['threshold_day']    # 95% - ä¿å®ˆ

    def get_next_task(self) -> Optional[Task]:
        """é€‰æ‹©ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§è°ƒåº¦ï¼‰"""
        # ä¼˜å…ˆçº§é¡ºåºï¼šSERIOUS > THOUGHT > GENERATED

        # 1. é¦–å…ˆå°è¯•è·å–ä¸¥è‚ƒä»»åŠ¡
        task = self.task_queue.get_task_by_priority(TaskPriority.SERIOUS)
        if task:
            return task

        # 2. ç„¶åæ˜¯éšæœºæƒ³æ³•
        task = self.task_queue.get_task_by_priority(TaskPriority.THOUGHT)
        if task:
            return task

        # 3. æœ€åæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ä»»åŠ¡
        task = self.task_queue.get_task_by_priority(TaskPriority.GENERATED)
        return task
```

**æ—¶é—´çª—å£ä¼˜åŒ–ï¼š**
- **å¤œé—´ï¼ˆ1 AM - 9 AMï¼‰**ï¼š96% é˜ˆå€¼ï¼Œå……åˆ†åˆ©ç”¨ç¡çœ æ—¶é—´
- **ç™½å¤©ï¼ˆ9 AM - 1 AMï¼‰**ï¼š95% é˜ˆå€¼ï¼Œä¸ºæ‰‹åŠ¨ä½¿ç”¨ä¿ç•™å®¹é‡

**ä½¿ç”¨ç›‘æ§ï¼š**
```python
def get_current_usage(self) -> float:
    """é€šè¿‡ Claude CLI è·å–ä½¿ç”¨æƒ…å†µ"""
    result = subprocess.run(
        ['claude', '/usage'],
        capture_output=True,
        text=True,
        timeout=10
    )

    # è§£æè¾“å‡ºï¼ˆç¤ºä¾‹æ ¼å¼ï¼š"Usage: 1234/5000 (24.68%)"ï¼‰
    match = re.search(r'(\d+\.\d+)%', result.stdout)
    if match:
        return float(match.group(1))

    return 0.0
```

---

### 3. å¤šä»£ç†å·¥ä½œæµï¼ˆPlanner/Worker/Evaluatorï¼‰

**ä¸‰é˜¶æ®µæ‰§è¡Œæµç¨‹ï¼š**

```python
class MultiAgentExecutor:
    async def execute_with_workflow(self, task: Task) -> Result:
        """ä½¿ç”¨å¤šä»£ç†å·¥ä½œæµæ‰§è¡Œä»»åŠ¡"""

        # Phase 1: Planner Agent
        plan = await self._plan_phase(task)

        # Phase 2: Worker Agent
        result = await self._work_phase(task, plan)

        # Phase 3: Evaluator Agent
        evaluation = await self._eval_phase(task, result)

        # æ ¹æ®è¯„ä¼°å†³å®šæ˜¯å¦æ¥å—ç»“æœ
        if evaluation['passed']:
            return result
        else:
            # å¦‚æœè¯„ä¼°å¤±è´¥ï¼Œå¯ä»¥é‡è¯•æˆ–æ ‡è®°ä¸ºå¤±è´¥
            logger.warning(f"Task {task.id} failed evaluation: {evaluation['reason']}")
            return Result(status='failed', error=evaluation['reason'])

    async def _plan_phase(self, task: Task) -> str:
        """Planner Agentï¼šåˆ†æä»»åŠ¡å¹¶åˆ›å»ºè®¡åˆ’"""
        prompt = self.config['planner']['prompt_template'].format(
            task_description=task.description
        )

        response = await self.claude_sdk.query(
            prompt=prompt,
            max_turns=self.config['planner']['max_turns']
        )

        return response  # è¿”å›è®¡åˆ’æ–‡æœ¬

    async def _work_phase(self, task: Task, plan: str) -> Result:
        """Worker Agentï¼šæ ¹æ®è®¡åˆ’æ‰§è¡Œä»»åŠ¡"""
        prompt = self.config['worker']['prompt_template'].format(
            task_description=task.description,
            plan=plan
        )

        response = await self.claude_sdk.query(
            prompt=prompt,
            max_turns=self.config['worker']['max_turns'],
            workspace=self._get_workspace(task)
        )

        return Result(
            status='completed',
            output=response,
            workspace=self._get_workspace(task)
        )

    async def _eval_phase(self, task: Task, result: Result) -> dict:
        """Evaluator Agentï¼šéªŒè¯å®Œæˆçš„å·¥ä½œ"""
        prompt = self.config['evaluator']['prompt_template'].format(
            task_description=task.description,
            result=result.output
        )

        response = await self.claude_sdk.query(
            prompt=prompt,
            max_turns=self.config['evaluator']['max_turns']
        )

        # è§£æè¯„ä¼°ç»“æœ
        return self._parse_evaluation(response)
```

**è§’è‰²ä¸“ä¸šåŒ–ï¼š**
- **Planner**ï¼šä¸“æ³¨äºåˆ†æå’Œè§„åˆ’ï¼Œä¸æ‰§è¡Œä»£ç 
- **Worker**ï¼šä¸“æ³¨äºæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨æ‰€æœ‰å·¥å…·ï¼ˆEdit, Write, Bash ç­‰ï¼‰
- **Evaluator**ï¼šä¸“æ³¨äºéªŒè¯ï¼Œæ£€æŸ¥æ­£ç¡®æ€§ã€å®Œæ•´æ€§å’Œè´¨é‡

---

### 4. è‡ªåŠ¨ä»»åŠ¡ç”Ÿæˆç­–ç•¥

**ä¸‰ç§ç”Ÿæˆç­–ç•¥ï¼š**

```python
class AutoTaskGenerator:
    def __init__(self, config: dict):
        self.strategies = {
            'refine_focused': self._refine_focused_strategy,
            'balanced': self._balanced_strategy,
            'new_friendly': self._new_friendly_strategy
        }
        self.weights = config['auto_generation']['strategies']

    async def generate_task(self) -> Optional[Task]:
        """æ ¹æ®æƒé‡éšæœºé€‰æ‹©ç­–ç•¥å¹¶ç”Ÿæˆä»»åŠ¡"""
        strategy = self._weighted_choice(self.weights)
        return await self.strategies[strategy]()

    async def _refine_focused_strategy(self) -> Task:
        """æ”¹è¿›ç°æœ‰å·¥ä½œï¼ˆ45% æƒé‡ï¼‰"""
        # 1. æŸ¥æ‰¾æœ€è¿‘çš„æœªå®Œæˆä»»åŠ¡
        recent_tasks = self.task_queue.get_recent_tasks(limit=10)

        # 2. åˆ†æå“ªäº›ä»»åŠ¡å¯ä»¥æ”¹è¿›
        for task in recent_tasks:
            if self._can_be_refined(task):
                return Task(
                    description=f"[REFINE:#{task.id}] Improve and complete {task.description}",
                    priority=TaskPriority.GENERATED,
                    task_type=TaskType.REFINE,
                    refine_task_id=task.id
                )

        return None

    async def _balanced_strategy(self) -> Task:
        """æ··åˆç­–ç•¥ï¼ˆ35% æƒé‡ï¼‰"""
        # 50% æœºä¼šæ”¹è¿›ï¼Œ50% æœºä¼šåˆ›å»ºæ–°ä»»åŠ¡
        if random.random() < 0.5:
            return await self._refine_focused_strategy()
        else:
            return await self._new_friendly_strategy()

    async def _new_friendly_strategy(self) -> Task:
        """åˆ›å»ºæ–°é¡¹ç›®ï¼ˆ20% æƒé‡ï¼‰"""
        # 1. ä» Claude è·å–åˆ›æ„
        prompt = """
        Suggest a new, innovative project idea that would be useful.
        Focus on:
        - Practical utility
        - Novelty
        - Feasibility

        Provide a one-sentence description.
        """

        response = await self.claude_sdk.query(prompt=prompt, max_turns=1)

        # 2. åˆ›å»ºä»»åŠ¡
        return Task(
            description=f"[NEW] {response}",
            priority=TaskPriority.GENERATED,
            task_type=TaskType.NEW
        )

    def _weighted_choice(self, weights: dict) -> str:
        """æ ¹æ®æƒé‡éšæœºé€‰æ‹©"""
        choices = list(weights.keys())
        weights_list = list(weights.values())
        return random.choices(choices, weights=weights_list)[0]
```

**å·¥ä½œç©ºé—´ç­–ç•¥ï¼š**
- **NEW ä»»åŠ¡**ï¼šåˆ›å»ºæ–°çš„éš”ç¦»å·¥ä½œç©ºé—´ `workspace/tasks/<task_id>/`
- **REFINE ä»»åŠ¡**ï¼šé‡ç”¨åŸå§‹ä»»åŠ¡çš„å·¥ä½œç©ºé—´ï¼Œä¿æŒè¿ç»­æ€§

---

## å¼€å‘æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°çš„ Slack å‘½ä»¤

**æ­¥éª¤ï¼š**

1. **åœ¨ Slack App é…ç½®ä¸­æ·»åŠ å‘½ä»¤**
   - è®¿é—® https://api.slack.com/apps/your-app/slash-commands
   - ç‚¹å‡» "Create New Command"
   - è®¾ç½®å‘½ä»¤åç§°ï¼ˆå¦‚ `/analyze`ï¼‰å’Œæè¿°

2. **åœ¨ `interfaces/bot.py` ä¸­æ·»åŠ å¤„ç†å™¨**

```python
@app.command("/analyze")
def handle_analyze(ack, command, client):
    """å¤„ç† /analyze å‘½ä»¤"""
    ack()  # ç«‹å³ç¡®è®¤

    # è§£æå‚æ•°
    text = command['text']

    # æ‰§è¡Œé€»è¾‘
    try:
        result = analyzer.analyze(text)

        # å›å¤ç”¨æˆ·
        client.chat_postMessage(
            channel=command['channel_id'],
            text=f"âœ… åˆ†æå®Œæˆï¼š\n{result}"
        )
    except Exception as e:
        client.chat_postMessage(
            channel=command['channel_id'],
            text=f"âŒ é”™è¯¯ï¼š{str(e)}"
        )
```

3. **åœ¨ `interfaces/cli.py` ä¸­æ·»åŠ  CLI å‘½ä»¤ï¼ˆå¯é€‰ï¼‰**

```python
@click.command()
@click.argument('target')
def analyze(target):
    """åˆ†ææŒ‡å®šç›®æ ‡"""
    result = analyzer.analyze(target)
    console.print(result)

cli.add_command(analyze)
```

---

### å¦‚ä½•æ‰©å±•ä»»åŠ¡ç±»å‹

**æ­¥éª¤ï¼š**

1. **åœ¨ `core/models.py` ä¸­æ·»åŠ æ–°çš„æšä¸¾å€¼**

```python
class TaskType(enum.Enum):
    NEW = "new"
    REFINE = "refine"
    ANALYZE = "analyze"  # æ–°å¢
```

2. **åœ¨ `core/executor.py` ä¸­å¤„ç†æ–°ç±»å‹**

```python
async def execute(self, task: Task) -> Result:
    if task.task_type == TaskType.ANALYZE:
        return await self._execute_analyze_task(task)
    # ... å…¶ä»–ç±»å‹
```

3. **æ›´æ–°ä»»åŠ¡åˆ›å»ºé€»è¾‘**

```python
# åœ¨å‘½ä»¤å¤„ç†å™¨ä¸­
task = Task(
    description=description,
    task_type=TaskType.ANALYZE,
    priority=priority
)
```

---

### å¦‚ä½•è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥

**æ­¥éª¤ï¼š**

1. **åˆ›å»ºè‡ªå®šä¹‰è°ƒåº¦å™¨ç±»**

```python
from sleepless_agent.scheduling.scheduler import SmartScheduler

class CustomScheduler(SmartScheduler):
    def should_generate_tasks(self) -> bool:
        """è‡ªå®šä¹‰é€»è¾‘"""
        # ä¾‹å¦‚ï¼šåªåœ¨ç‰¹å®šæ—¥æœŸç”Ÿæˆä»»åŠ¡
        if datetime.now().weekday() in [5, 6]:  # å‘¨æœ«
            return False

        return super().should_generate_tasks()

    def get_next_task(self) -> Optional[Task]:
        """è‡ªå®šä¹‰ä»»åŠ¡é€‰æ‹©é€»è¾‘"""
        # ä¾‹å¦‚ï¼šä¼˜å…ˆå¤„ç†ç‰¹å®šé¡¹ç›®çš„ä»»åŠ¡
        task = self.task_queue.get_task_by_project("critical-project")
        if task:
            return task

        return super().get_next_task()
```

2. **åœ¨ `daemon.py` ä¸­ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨**

```python
from my_module import CustomScheduler

class SleeplessAgent:
    def __init__(self, config):
        # ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨
        self.scheduler = CustomScheduler(config)
```

---

## æŠ€æœ¯äº®ç‚¹å’Œåˆ›æ–°ç‚¹

### 1. å·¥ä½œç©ºé—´éš”ç¦»è®¾è®¡

**é—®é¢˜ï¼š** å¦‚ä½•å®‰å…¨åœ°å¹¶è¡Œæ‰§è¡Œå¤šä¸ª AI ä»»åŠ¡è€Œä¸äº’ç›¸å¹²æ‰°ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
- æ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹ç›®å½•ä¸­æ‰§è¡Œ
- ä¸¥æ ¼çš„è·¯å¾„æƒé™æ§åˆ¶
- å…±äº«èµ„æºé€šè¿‡ `workspace/shared/` ç›®å½•
- ç³»ç»Ÿç›®å½•ï¼ˆ`data/`ï¼‰å—ä¿æŠ¤ï¼Œä»»åŠ¡æ— æ³•è®¿é—®

**å®ç°ç»†èŠ‚ï¼š**

```python
class WorkspaceManager:
    def setup_task_workspace(self, task: Task) -> str:
        """ä¸ºä»»åŠ¡è®¾ç½®éš”ç¦»å·¥ä½œç©ºé—´"""
        if task.project_name:
            # ä¸¥è‚ƒä»»åŠ¡ -> é¡¹ç›®å·¥ä½œç©ºé—´
            workspace = f"workspace/projects/{task.project_name}"
        else:
            # éšæœºæƒ³æ³• -> ä»»åŠ¡å·¥ä½œç©ºé—´
            workspace = f"workspace/tasks/task_{task.id}"

        # åˆ›å»ºç›®å½•
        os.makedirs(workspace, exist_ok=True)

        # è®¾ç½®æƒé™ï¼ˆåªè¯»å…±äº«ï¼Œè¯»å†™è‡ªå·±ï¼‰
        self._setup_permissions(workspace)

        # åˆ›å»ºç¬¦å·é“¾æ¥åˆ°å…±äº«èµ„æº
        os.symlink(
            "workspace/shared",
            f"{workspace}/shared",
            target_is_directory=True
        )

        return workspace

    def _setup_permissions(self, workspace: str):
        """è®¾ç½®ç›®å½•æƒé™"""
        # ä»»åŠ¡åªèƒ½è®¿é—®ï¼š
        # - è‡ªå·±çš„å·¥ä½œç©ºé—´ï¼ˆè¯»å†™ï¼‰
        # - shared/ ç›®å½•ï¼ˆåªè¯»ï¼‰
        # - ä¸èƒ½è®¿é—® data/ ç›®å½•
        pass  # å®é™…å®ç°ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæƒé™æˆ– Docker å®¹å™¨
```

**ä¼˜åŠ¿ï¼š**
- **å®‰å…¨æ€§**ï¼šä»»åŠ¡æ— æ³•è®¿é—®å…¶ä»–ä»»åŠ¡çš„æ•°æ®
- **å¯é æ€§**ï¼šä¸€ä¸ªä»»åŠ¡çš„å´©æºƒä¸å½±å“å…¶ä»–ä»»åŠ¡
- **å¯æ‰©å±•æ€§**ï¼šç†è®ºä¸Šå¯ä»¥å¹¶è¡Œæ‰§è¡Œæ— é™ä¸ªä»»åŠ¡

---

### 2. Claude Code SDK é›†æˆæ–¹å¼

**åˆ›æ–°ç‚¹ï¼š** ä¸ç›´æ¥è°ƒç”¨ Claude APIï¼Œè€Œæ˜¯é€šè¿‡ Claude Code CLI å’Œ Python Agent SDK

**ä¼˜åŠ¿ï¼š**
1. **å·¥å…·ç”Ÿæ€ç³»ç»Ÿ**ï¼šClaude Code å†…ç½®äº†ä¸°å¯Œçš„å·¥å…·ï¼ˆEdit, Write, Bash, Grep ç­‰ï¼‰
2. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šCLI è‡ªåŠ¨å¤„ç†å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡çª—å£
3. **é…é¢ç»Ÿä¸€**ï¼šä½¿ç”¨ Claude Code Pro è®¡åˆ’çš„é…é¢ï¼Œæ— éœ€å•ç‹¬çš„ API å¯†é’¥
4. **æœ¬åœ°ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ“ä½œåœ¨æœ¬åœ°æ‰§è¡Œï¼Œæ•°æ®ä¸ç¦»å¼€æœºå™¨

**å®ç°ç¤ºä¾‹ï¼š**

```python
from claude_agent_sdk import ClaudeAgentSDK

class ClaudeCodeExecutor:
    def __init__(self, config: dict):
        self.sdk = ClaudeAgentSDK(
            binary_path=config['claude_code']['binary_path'],
            model=config['claude_code']['model']
        )

    async def execute(self, task: Task) -> Result:
        """ä½¿ç”¨ SDK æ‰§è¡Œä»»åŠ¡"""
        response = await self.sdk.query(
            prompt=task.description,
            workspace=self._get_workspace(task),
            max_turns=10,  # æ”¯æŒå¤šè½®å¯¹è¯
            tools=['edit', 'write', 'bash', 'grep', 'read']
        )

        return self._parse_response(response)
```

---

### 3. æ™ºèƒ½é…é¢ç®¡ç†

**åˆ›æ–°ç‚¹ï¼š** æ—¶é—´æ„ŸçŸ¥çš„ä½¿ç”¨é˜ˆå€¼

**ä¸ºä»€ä¹ˆé‡è¦ï¼š**
- Claude Code Pro è®¡åˆ’æœ‰æ¯æ—¥ä½¿ç”¨é™åˆ¶
- éœ€è¦å¹³è¡¡è‡ªä¸»æ€§å’Œä¿ç•™æ‰‹åŠ¨ä½¿ç”¨çš„å®¹é‡

**ç­–ç•¥ï¼š**
- **å¤œé—´ï¼ˆ1 AM - 9 AMï¼‰**ï¼š96% é˜ˆå€¼ - ç”¨æˆ·ç¡è§‰æ—¶å……åˆ†åˆ©ç”¨
- **ç™½å¤©ï¼ˆ9 AM - 1 AMï¼‰**ï¼š95% é˜ˆå€¼ - ä¸ºç”¨æˆ·æ‰‹åŠ¨ä½¿ç”¨ä¿ç•™ 5%

**åŠ¨æ€è°ƒæ•´ï¼š**

```python
def get_adaptive_threshold(self) -> float:
    """æ ¹æ®å†å²ä½¿ç”¨æ¨¡å¼è‡ªé€‚åº”è°ƒæ•´é˜ˆå€¼"""
    # åˆ†æè¿‡å» 7 å¤©çš„ä½¿ç”¨æ¨¡å¼
    history = self.usage_history.get_last_days(7)

    # å¦‚æœç”¨æˆ·ç™½å¤©å¾ˆå°‘æ‰‹åŠ¨ä½¿ç”¨ï¼Œå¯ä»¥æé«˜ç™½å¤©é˜ˆå€¼
    avg_manual_usage = self._calculate_manual_usage(history)

    if avg_manual_usage < 10:  # ç”¨æˆ·å¾ˆå°‘æ‰‹åŠ¨ä½¿ç”¨
        return self.threshold_day + 2  # æé«˜åˆ° 97%
    else:
        return self.threshold_day  # ä¿æŒ 95%
```

---

## æ€»ç»“

Sleepless Agent æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ 24/7 AI ä»£ç†ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **å®Œå…¨è‡ªä¸»**ï¼šæ— éœ€äººå·¥å¹²é¢„å³å¯æŒç»­è¿è¡Œ
2. **æ™ºèƒ½è°ƒåº¦**ï¼šåŸºäºæ—¶é—´å’Œé…é¢çš„ä¼˜åŒ–ä»»åŠ¡æ‰§è¡Œ
3. **å®‰å…¨éš”ç¦»**ï¼šæ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹å·¥ä½œç©ºé—´ä¸­æ‰§è¡Œ
4. **æ·±åº¦é›†æˆ**ï¼šä¸ Slackã€Gitã€Claude Code æ— ç¼é›†æˆ
5. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¸ªäººå¼€å‘è€…ï¼šè‡ªåŠ¨åŒ–é‡å¤æ€§å¼€å‘ä»»åŠ¡
- å›¢é˜Ÿåä½œï¼šé€šè¿‡ Slack é›†ä¸­ç®¡ç† AI ä»»åŠ¡
- ç ”ç©¶æ¢ç´¢ï¼šåˆ©ç”¨ç©ºé—²æ—¶é—´æ¢ç´¢æ–°æƒ³æ³•
- æŒç»­é›†æˆï¼šè‡ªåŠ¨ä»£ç å®¡æŸ¥ã€æµ‹è¯•ã€æ–‡æ¡£ç”Ÿæˆ

**æŠ€æœ¯æ ˆæ€»ç»“ï¼š**
- Python 3.11+ | Claude Code CLI | Slack Bolt SDK
- SQLAlchemy + SQLite | GitPython | Rich

**é¡¹ç›®é“¾æ¥ï¼š**
- GitHub: https://github.com/context-machine-lab/sleepless-agent
- æ–‡æ¡£: https://context-machine-lab.github.io/sleepless-agent/
- PyPI: https://pypi.org/project/sleepless-agent/

---

*æœ€åæ›´æ–°ï¼š2025-12-31*
*æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0*
